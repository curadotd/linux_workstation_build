#!/bin/bash

current_dir=$(pwd)

# Ask user if they want to use picom files
read -p "Do you want to install picom? (y/n) " install_picom

# Ask user to create a default git location
read -p "Do you want to create a default location for git repositories? (y/n) " create_git_dir
if [[ $create_git_dir =~ ^[Yy]$ ]]; then
    read -p "Enter the path for git repositories (default: $HOME/git): " git_path
    git_path=${git_path:-$HOME/git}
    
    if [ ! -d "$git_path" ]; then
        mkdir -p "$git_path"
        echo "Created git directory at $git_path"
    else
        echo "Git directory already exists at $git_path"
    fi
    
    # Export the git path to use later in the script
    export GIT_PATH="$git_path"
else
    echo "Skipping git directory creation."
fi

if [[ $install_picom =~ ^[Yy]$ ]]; then
    echo "Installing picom..."

    # Check if picom exists
    if ! command -v picom &> /dev/null; then
        if [ ! -d $git_path/picom ]; then
            if ! git clone https://github.com/FT-Labs/picom.git $git_path/picom; then
                echo "Failed to clone the repository"
                return 1
                fi
            else
                echo "Repository already exists, skipping clone"
            fi
            cd $git_path/picom || { echo "Failed to change directory to picom"; return 1; }
            # Check if the system is Debian-based
            if [ -f /etc/debian_version ] || (command -v lsb_release &> /dev/null && lsb_release -si | grep -qi "debian\|ubuntu"); then
                sudo apt install libev-dev libxcb-present-dev
            else
                echo "This system is not Debian-based. Please install the required dependencies manually."
                echo "Required packages: libev-dev, libxcb-present-dev"
                read -p "Press Enter to continue or Ctrl+C to exit..."
            fi
            # Build the project
            if ! meson setup --buildtype=release build; then
                echo "Meson setup failed"
                return 1
            fi
            if ! ninja -C build; then
                echo "Ninja build failed"
                return 1
            fi
            # Install the built binary
            if ! sudo ninja -C build install; then
                echo "Failed to install the built binary"
                return 1
            fi
            echo "Picom animations installed successfully"
            cd $current_dir
        else
            echo "Skipping picom compilation"
            cd $current_dir
        fi
    else
        echo "picom is already installed"
        cd $current_dir
    fi
else
    echo "Skipping picom install."
    cd $current_dir
fi
