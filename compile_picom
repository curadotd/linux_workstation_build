#!/bin/bash

# Ask user if they want to use picom files
read -p "Do you want to install picom? (y/n) " install_picom

if [[ $install_picom =~ ^[Yy]$ ]]; then
    echo "Installing picom..."

    # Check if picom exists
    if ! command -v picom &> /dev/null; then
        read -p "picom is not installed. Would you like to compile it? (y/n): " compile_picom
        if [ "$compile_picom" = "y" ]; then
            # Clone the repository in the home/git directory
            if [ ! -d $git_path/picom ]; then
                if ! git clone https://github.com/FT-Labs/picom.git $git_path/picom; then
                    echo "Failed to clone the repository"
                    return 1
                fi
            else
                echo "Repository already exists, skipping clone"
            fi
            cd $git_path/picom || { echo "Failed to change directory to picom"; return 1; }
            # Check if the system is Debian-based
            if [ -f /etc/debian_version ] || (command -v lsb_release &> /dev/null && lsb_release -si | grep -qi "debian\|ubuntu"); then
                sudo apt install libev-dev libxcb-present-dev
            else
                echo "This system is not Debian-based. Please install the required dependencies manually."
                echo "Required packages: libev-dev, libxcb-present-dev"
                read -p "Press Enter to continue or Ctrl+C to exit..."
            fi
            # Build the project
            if ! meson setup --buildtype=release build; then
                echo "Meson setup failed"
                return 1
            fi
            if ! ninja -C build; then
                echo "Ninja build failed"
                return 1
            fi
            # Install the built binary
            if ! sudo ninja -C build install; then
                echo "Failed to install the built binary"
                return 1
            fi
            echo "Picom animations installed successfully"
        else
            echo "Skipping picom compilation"
        fi
    else
        echo "picom is already installed"
    fi

else
    echo "Skipping picom install."
fi
